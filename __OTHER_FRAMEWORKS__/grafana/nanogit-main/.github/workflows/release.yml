name: Release

on:
  push:
    branches:
      - main

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

# Restrict workflow-level permissions to read-only by default
permissions:
  contents: read

jobs:
  # Wait for CI to complete before releasing
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Wait for CI checks
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc # v1.3.4
        with:
          ref: ${{ github.sha }}
          check-regexp: '.*'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success,skipped
          # Exclude this workflow from the checks
          running-workflow-name: 'Wait for CI'

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: wait-for-ci
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install semantic-release
        run: |
          npm install -g \
            semantic-release@23 \
            @semantic-release/changelog@6 \
            @semantic-release/github@10 \
            @semantic-release/commit-analyzer@12 \
            @semantic-release/release-notes-generator@13 \
            conventional-changelog-conventionalcommits@7

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify release configuration
        env:
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "Checking for .releaserc.json..."
          cat .releaserc.json
          echo "Repository: ${REPO}"
          echo "Branch: ${BRANCH}"

      - name: Get last release
        id: last_release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
          echo "Last release tag: $LAST_TAG"

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release

      - name: Get new release
        id: new_release
        run: |
          NEW_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "New release tag: $NEW_TAG"

      - name: Create CHANGELOG PR
        if: steps.new_release.outputs.new_tag != 'none' && steps.new_release.outputs.new_tag != steps.last_release.outputs.last_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSION: ${{ steps.new_release.outputs.new_tag }}
          REPO: ${{ github.repository }}
        run: |
          # Check if CHANGELOG.md was modified
          if git diff --quiet CHANGELOG.md; then
            echo "CHANGELOG.md not modified, skipping PR creation"
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and checkout new branch
          BRANCH_NAME="chore/changelog-${NEW_VERSION}"
          git checkout -b "${BRANCH_NAME}"

          # Commit CHANGELOG
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for ${NEW_VERSION}"

          # Push branch
          git push origin "${BRANCH_NAME}"

          # Create PR with auto-merge
          PR_BODY="Automated CHANGELOG update for release ${NEW_VERSION}.

          This PR was automatically generated by the release workflow.

          **Release:** [${NEW_VERSION}](https://github.com/${REPO}/releases/tag/${NEW_VERSION})

          ðŸ¤– Auto-merge enabled - will merge automatically once CI passes."

          PR_URL=$(gh pr create \
            --title "chore: update CHANGELOG for ${NEW_VERSION}" \
            --body "${PR_BODY}" \
            --base main \
            --head "${BRANCH_NAME}")

          # Enable auto-merge on the PR (gh pr merge accepts URLs)
          gh pr merge "${PR_URL}" --auto --squash

      - name: Notify pkg.go.dev
        if: steps.new_release.outputs.new_tag != 'none' && steps.new_release.outputs.new_tag != steps.last_release.outputs.last_tag
        run: |
          echo "New version released: ${{ steps.new_release.outputs.new_tag }}"
          echo "pkg.go.dev will automatically index this release within a few minutes"
          echo "View at: https://pkg.go.dev/github.com/grafana/nanogit@${{ steps.new_release.outputs.new_tag }}"

      - name: Summary
        if: steps.new_release.outputs.new_tag != 'none' && steps.new_release.outputs.new_tag != steps.last_release.outputs.last_tag
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** \`${{ steps.new_release.outputs.new_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** \`${{ steps.last_release.outputs.last_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Package Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.new_release.outputs.new_tag }})" >> $GITHUB_STEP_SUMMARY
          echo "- [pkg.go.dev](https://pkg.go.dev/github.com/grafana/nanogit@${{ steps.new_release.outputs.new_tag }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Go Module Proxy](https://proxy.golang.org/github.com/grafana/nanogit/@v/${{ steps.new_release.outputs.new_tag }}.info)" >> $GITHUB_STEP_SUMMARY

      - name: No release needed
        if: steps.new_release.outputs.new_tag == steps.last_release.outputs.last_tag
        run: |
          echo "## â„¹ï¸ No Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new release was created. This can happen when:" >> $GITHUB_STEP_SUMMARY
          echo "- Commits don't follow conventional commit format" >> $GITHUB_STEP_SUMMARY
          echo "- Only non-release commits (docs, chore, ci, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "- Commit message contains \`[skip ci]\` or \`[skip release]\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit message format:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix: ...\` â†’ Patch release (v0.1.0 â†’ v0.1.1)" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat: ...\` â†’ Minor release (v0.1.0 â†’ v0.2.0)" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat!: ...\` or \`BREAKING CHANGE:\` â†’ Major release (v0.1.0 â†’ v1.0.0)" >> $GITHUB_STEP_SUMMARY
