---
apiVersion: helm-chart-toolbox.grafana.com/v1
kind: TestPlan
name: k8s-o11y

subject:
  path: ../../..
  valuesFile: values.yaml
  set:
    - key: "cluster.name"
      valueFrom: clusterName

cluster:
  type: kind
  appendRandomNumber: true

dependencies:
  - file: ../grafana-cloud-credentials.yaml
  - file: ../grafana-cloud-credentials.yaml
    namespace: toolbox
  - preset: test-parameters
    namespace: toolbox

tests:
  - type: query-test
    values:
      tests:
        - envFrom:
            - secretRef: {name: grafana-cloud}
            - configMapRef: {name: test-parameters}
          env:
            PROMETHEUS_URL: https://prometheus-prod-13-prod-us-east-0.grafana.net/api/prom/api/v1/query
          queries:
            # Beyla Surveyor
            - query: survey_info{k8s_cluster_name="$clusterName", k8s_deployment_name="k8s-o11y-kube-state-metrics"}
              type: promql
            - query: survey_info{k8s_cluster_name="$clusterName", k8s_daemonset_name="k8s-o11y-prometheus-node-exporter"}
              type: promql

            # kube-state-metrics
            - query: kube_node_info{cluster="$clusterName"}
              type: promql
