version: 2

# Use 'release' directory for goreleaser output (dist/ is used for embedded assets)
dist: release

# Hooks to run before the build
before:
  hooks:
    # Generate embedded assets (SQLite FTS5 index, TypeScript types, Terraform docs)
    - make prepare

# Build configuration
builds:
  - id: mcp-k6
    main: ./cmd/mcp-k6
    binary: mcp-k6

    # Build tags required for SQLite FTS5 support
    tags:
      - fts5
      - sqlite_fts5

    # Inject build metadata via ldflags
    ldflags:
      - -s -w
      - -X github.com/grafana/mcp-k6/internal/buildinfo.Version={{.Version}}
      - -X github.com/grafana/mcp-k6/internal/buildinfo.Commit={{.ShortCommit}}
      - -X github.com/grafana/mcp-k6/internal/buildinfo.Date={{.Date}}

    # Enable trimpath for reproducible builds
    flags:
      - -trimpath

    # Target platforms - ONLY Linux and Windows
    goos:
      - linux
      - windows

    goarch:
      - amd64
      - arm64

    # Exclude unsupported combinations
    ignore:
      - goos: windows
        goarch: arm64

    # CGO is required for SQLite
    env:
      - CGO_ENABLED=1

    # Zig Cross-Compilation Configuration
    overrides:
      # Linux ARM64
      - goos: linux
        goarch: arm64
        env:
          - CGO_ENABLED=1
          - CC=zig cc -target aarch64-linux-gnu

      # Linux AMD64
      - goos: linux
        goarch: amd64
        env:
          - CGO_ENABLED=1
          - CC=zig cc -target x86_64-linux-gnu

      # Windows AMD64
      # Note: Windows cross-compilation uses Zig with MinGW-compatible target
      - goos: windows
        goarch: amd64
        env:
          - CGO_ENABLED=1
          - CC=zig cc -target x86_64-windows-gnu

# Archive configuration
archives:
  - id: mcp-k6-archives
    # Use tar.gz for Unix-like systems (better for curl | sh pattern), zip for Windows
    formats: ['tar.gz']
    format_overrides:
      - goos: windows
        formats: ['zip']

    # Archive name template
    name_template: "mcp-k6_{{ .Version }}_{{ .Os }}_{{ .Arch }}"

    # Files to include in the archive
    files:
      - README.md
      - LICENSE

# Package configuration (.deb and .rpm)
nfpms:
  - id: mcp-k6-packages
    package_name: mcp-k6

    # Replace existing packages on upgrade
    replaces:
      - mcp-k6

    # Package formats
    formats:
      - deb
      - rpm

    # Vendor and maintainer information
    vendor: Grafana Labs
    maintainer: Grafana Labs <noreply@grafana.com>

    # Package metadata
    description: |
      An experimental MCP (Model Context Protocol) server for k6, written in Go.
      Provides k6 script validation, test execution, fast full-text documentation
      search (embedded SQLite FTS5), and guided script generation via MCP tools,
      resources, and prompts.

    homepage: https://github.com/grafana/mcp-k6
    license: AGPL-3.0

    # Binary installation location
    bindir: /usr/bin

    # Additional files to include
    contents:
      # Documentation files
      - src: README.md
        dst: /usr/share/doc/mcp-k6/README.md
      - src: LICENSE
        dst: /usr/share/doc/mcp-k6/LICENSE

    # Dependencies
    # k6 is recommended but not required (soft dependency)
    # For .rpm and .deb packages, this creates a "Recommends" field
    recommends:
      - k6

# Checksum configuration
checksum:
  name_template: "mcp-k6_{{ .Version }}_linux-windows_checksums.txt"
  algorithm: sha256

# NO release section - artifacts will be collected by the final release job

# Snapshot configuration (for local testing)
snapshot:
  version_template: "{{ .Version }}-SNAPSHOT-{{ .ShortCommit }}"

# Metadata
metadata:
  mod_timestamp: "{{ .CommitTimestamp }}"
