name: Convert and Integrate Sigma Rules

on:
  workflow_call:
    inputs:
      config_path:
        description: "Path to the Sigma conversion config file"
        required: true
        type: string
      plugin_packages:
        description: "Comma-separated list of Sigma CLI plugin packages to install"
        required: false
        type: string
        default: ""
      render_traceback:
        description: "Whether to render the traceback in the output"
        required: false
        type: boolean
        default: false
      pretty_print:
        description: "Pretty print the JSON output"
        required: false
        type: boolean
        default: false
      output_log_lines:
        description: "Output log lines to the outputs of the test_query_results"
        required: false
        type: boolean
        default: false
      all_rules:
        description: "Convert all rules specified in the config file, can be controlled by commenting `sigma convert all` in a PR"
        required: false
        type: boolean
        default: false
      actions_username:
        description: "Username of the automation that commits conversions"
        required: false
        type: string
        default: "github-actions[bot]"
      changed_files_from_base:
        description: "Whether to use the changed files from the base branch"
        required: false
        type: boolean
        default: false
      continue_on_query_testing_errors:
        description: "Continue integration process even when query testing fails, but print errors and continue the action"
        required: false
        type: boolean
        default: true
      vault_path:
        description: "A path to the Grafana service account token described in secrets.grafana_sa_token, but stored in Grafana's internal Vault"
        required: false
        type: string
        default: ""
    secrets:
      grafana_sa_token:
        description: "A Grafana service account token for testing queries, with at least the following role: Data sources:Reader"
        required: false

jobs:
  convert-integrate:
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request && github.event.action == 'created')
    runs-on: ubuntu-latest
    permissions:
      contents: write # to read Sigma rules and write intermediary files
      id-token: write # to get vault secrets
      packages: read # to pull the Action docker image
      pull-requests: write # to update the relevant pull request
    steps:
      - name: Get service account token for instance from Vault
        if: ${{ inputs.vault_path != '' }}
        uses: grafana/shared-workflows/actions/get-vault-secrets@main
        with:
          repo_secrets: ${{ format('GRAFANA_SA_TOKEN={0}', inputs.vault_path) }}

      - name: Get PR branch for comments
        if: github.event_name == 'issue_comment'
        id: get-pr-branch
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
            });
            console.log(`PR head branch: ${pullRequest.head.ref}`);
            return pullRequest.head.ref;
          result-encoding: string

      - name: Check whether to convert all rules and react
        id: convert_all
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        env:
          ALL_RULES: ${{ inputs.all_rules }}
        with:
          script: |
            const allRules = process.env.ALL_RULES === 'true';
            let convertAll = allRules;
            
            // Check comment body if this is an issue_comment event
            if (context.eventName === 'issue_comment' && context.payload.comment) {
              const commentBody = context.payload.comment.body.toLowerCase();
              
              if (commentBody.startsWith('sigma') && commentBody.includes('convert all')) {
                convertAll = true;
                
                // React with eyes emoji
                try {
                  await github.rest.reactions.createForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: context.payload.comment.id,
                    content: 'eyes'
                  });
                  console.log(`Reacted to comment ${context.payload.comment.id} with eyes emoji`);
                } catch (error) {
                  console.log(`Could not react to comment: ${error.message}`);
                }
              }
            }
            
            // Set output for convert_all
            core.setOutput('convert_all', convertAll.toString());
            console.log(`convert_all set to: ${convertAll}`);

      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          ref: ${{ github.event_name == 'issue_comment' && steps.get-pr-branch.outputs.result || github.head_ref }}
          fetch-depth: 0

      - name: Convert Sigma rules
        uses: grafana/sigma-rule-deployment/actions/convert@v0.1.3
        with:
          config_path: ${{ inputs.config_path }}
          plugin_packages: ${{ inputs.plugin_packages }}
          render_traceback: ${{ inputs.render_traceback }}
          pretty_print: ${{ inputs.pretty_print }}
          all_rules: ${{ steps.convert_all.outputs.convert_all }}
          actions_username: ${{ inputs.actions_username }}
          changed_files_from_base: ${{ inputs.changed_files_from_base }}

      - name: Integrate queries into alert rules
        uses: grafana/sigma-rule-deployment/actions/integrate@v0.1.3
        with:
          config_path: ${{ inputs.config_path }}
          grafana_sa_token: ${{ secrets.grafana_sa_token || env.GRAFANA_SA_TOKEN }}
          pretty_print: ${{ inputs.pretty_print }}
          output_log_lines: ${{ inputs.output_log_lines }}
          all_rules: ${{ steps.convert_all.outputs.convert_all }}
          actions_username: ${{ inputs.actions_username }}
          changed_files_from_base: ${{ inputs.changed_files_from_base }}

      - name: Commit queries and alert rules
        uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7.0.0
        with:
          commit_message: "Sigma Rules Deployment"
          branch: ${{ github.event_name == 'issue_comment' && steps.get-pr-branch.outputs.result || github.head_ref }}
          commit_options: '--allow-empty'
          skip_checkout: true
          skip_fetch: true
          skip_dirty_check: true
